{
  "name": "Healthcare CSKH - Complete System",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{"field": "hours", "hoursInterval": 1}]
        }
      },
      "id": "schedule-survey",
      "name": "‚è∞ Schedule Survey Send",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.BACKEND_URL }}/api/appointments?status=COMPLETED&limit=100",
        "options": {}
      },
      "id": "get-appointments",
      "name": "üîç Get Completed Appointments",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "const appointments = $input.first().json.data || [];\nconst items = [];\nconst twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n\nconsole.log(`Processing ${appointments.length} appointments...`);\n\nfor (const apt of appointments) {\n  const appointmentTime = new Date(apt.startTimeLocal);\n  if (!apt.survey_sent && appointmentTime <= twentyFourHoursAgo) {\n    items.push({ json: apt });\n    console.log(`‚úÖ ${apt.patientName} needs survey`);\n  }\n}\n\nconsole.log(`Found ${items.length} appointments needing surveys`);\nreturn items;"
      },
      "id": "filter-surveys",
      "name": "üéØ Filter Need Survey",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/emails/send-survey",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"appointmentId\": \"{{ $json.id }}\",\n  \"email\": \"{{ $json.email }}\",\n  \"fullName\": \"{{ $json.patientName }}\",\n  \"doctor\": \"{{ $json.doctor }}\"\n}",
        "options": {}
      },
      "id": "send-survey",
      "name": "üìß Send Survey Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $env.BACKEND_URL }}/api/appointments/{{ $json.id }}/survey-sent",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"survey_sent\": true,\n  \"survey_sent_at\": \"{{ $now.toISO() }}\"\n}",
        "options": {}
      },
      "id": "update-survey-sent",
      "name": "‚úÖ Mark Survey Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "survey-response",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-survey",
      "name": "üé§ Webhook Survey",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 600],
      "webhookId": "healthcare-survey"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/surveys/submit",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "process-survey",
      "name": "üìä Process Survey",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [460, 600]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.data.needsImprovement }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-improvement",
      "name": "‚ùì Needs Improvement?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 600]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/ai/analyze",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"surveyData\": {{ JSON.stringify($json.data.data) }}\n}",
        "options": {}
      },
      "id": "ai-analyze",
      "name": "ü§ñ AI Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/alerts/send",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"surveyData\": {{ JSON.stringify($('üìä Process Survey').item.json.data.data) }},\n  \"aiAnalysis\": \"{{ $json.data.analysis }}\"\n}",
        "options": {}
      },
      "id": "send-alert",
      "name": "üö® Send Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"message\": \"Survey received\" }",
        "options": {}
      },
      "id": "respond-survey",
      "name": "‚úâÔ∏è Respond Survey",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [680, 700]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "voice-event",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-voice",
      "name": "üìû Webhook Voice",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 900],
      "webhookId": "healthcare-voice"
    },
    {
      "parameters": {
        "jsCode": "const signature = $request.headers['x-elevenlabs-signature'];\nconst expected = $env.ELEVENLABS_WEBHOOK_SECRET;\n\nif (expected && signature !== expected) {\n  throw new Error('Invalid signature');\n}\n\nconsole.log('‚úÖ Webhook validated');\nreturn [$input.all()];"
      },
      "id": "validate-voice",
      "name": "üîê Validate Signature",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 900]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/voice-calls/webhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "process-voice",
      "name": "üéôÔ∏è Process Voice",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [680, 900]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.data.insights.sentiment }}",
              "operation": "equals",
              "value2": "NEGATIVE"
            }
          ]
        }
      },
      "id": "check-sentiment",
      "name": "‚ùì Negative?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 900]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/alerts/voice-alert",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callData\": {{ JSON.stringify($json.data) }}\n}",
        "options": {}
      },
      "id": "voice-alert",
      "name": "üö® Voice Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 800]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true }",
        "options": {}
      },
      "id": "respond-voice",
      "name": "‚úâÔ∏è Respond Voice",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [900, 1000]
    },
    {
      "parameters": {
        "rule": {
          "interval": [{"field": "hours", "hoursInterval": 2}]
        }
      },
      "id": "schedule-calls",
      "name": "‚è∞ Schedule Calls",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 1200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.BACKEND_URL }}/api/appointments/need-voice-call",
        "options": {}
      },
      "id": "get-call-candidates",
      "name": "üîç Get Call Candidates",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [460, 1200]
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {}
      },
      "id": "split-batches",
      "name": "üì¶ Split Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [680, 1200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/voice-calls/initiate/{{ $json.id }}",
        "options": {}
      },
      "id": "initiate-call",
      "name": "üìû Initiate Call",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 1200]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "wait-calls",
      "name": "‚è≥ Wait 5s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [1120, 1200]
    }
  ],
  "connections": {
    "‚è∞ Schedule Survey Send": {
      "main": [[{"node": "üîç Get Completed Appointments", "type": "main", "index": 0}]]
    },
    "üîç Get Completed Appointments": {
      "main": [[{"node": "üéØ Filter Need Survey", "type": "main", "index": 0}]]
    },
    "üéØ Filter Need Survey": {
      "main": [[{"node": "üìß Send Survey Email", "type": "main", "index": 0}]]
    },
    "üìß Send Survey Email": {
      "main": [[{"node": "‚úÖ Mark Survey Sent", "type": "main", "index": 0}]]
    },
    "üé§ Webhook Survey": {
      "main": [[{"node": "üìä Process Survey", "type": "main", "index": 0}]]
    },
    "üìä Process Survey": {
      "main": [[
        {"node": "‚ùì Needs Improvement?", "type": "main", "index": 0},
        {"node": "‚úâÔ∏è Respond Survey", "type": "main", "index": 0}
      ]]
    },
    "‚ùì Needs Improvement?": {
      "main": [[{"node": "ü§ñ AI Analysis", "type": "main", "index": 0}]]
    },
    "ü§ñ AI Analysis": {
      "main": [[{"node": "üö® Send Alert", "type": "main", "index": 0}]]
    },
    "üìû Webhook Voice": {
      "main": [[{"node": "üîê Validate Signature", "type": "main", "index": 0}]]
    },
    "üîê Validate Signature": {
      "main": [[{"node": "üéôÔ∏è Process Voice", "type": "main", "index": 0}]]
    },
    "üéôÔ∏è Process Voice": {
      "main": [[
        {"node": "‚ùì Negative?", "type": "main", "index": 0},
        {"node": "‚úâÔ∏è Respond Voice", "type": "main", "index": 0}
      ]]
    },
    "‚ùì Negative?": {
      "main": [[{"node": "üö® Voice Alert", "type": "main", "index": 0}]]
    },
    "‚è∞ Schedule Calls": {
      "main": [[{"node": "üîç Get Call Candidates", "type": "main", "index": 0}]]
    },
    "üîç Get Call Candidates": {
      "main": [[{"node": "üì¶ Split Batches", "type": "main", "index": 0}]]
    },
    "üì¶ Split Batches": {
      "main": [[{"node": "üìû Initiate Call", "type": "main", "index": 0}]]
    },
    "üìû Initiate Call": {
      "main": [[{"node": "‚è≥ Wait 5s", "type": "main", "index": 0}]]
    },
    "‚è≥ Wait 5s": {
      "main": [[{"node": "üì¶ Split Batches", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 3,
  "updatedAt": "2025-11-24T00:00:00.000Z",
  "versionId": "1"
}
